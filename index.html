<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đặt chỗ - 2 cột (đã đảo, không có cụm rạp/suất)</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#0f1113;
      --muted:#9aa0a6;
      --green:#2ed573;
      --yellow:#f5b942;
      --sold:#2f3134;
      --card:#121214;
      --radius:12px;
      --seat-w:56px;
      --seat-h:44px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff;min-height:100vh}
    .wrap{max-width:1200px;margin:20px auto;padding:20px;display:grid;grid-template-columns:380px 1fr;gap:20px}
    header{grid-column:1/-1;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0 0 6px 0}
    .legend{display:flex;gap:12px;align-items:center}
    .legend .item{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
    .sw{width:18px;height:18px;border-radius:6px;border:2px solid rgba(255,255,255,0.04)}
    .sw.empty{background:transparent;border-color:var(--green)}
    .sw.sel{background:var(--yellow)}
    .sw.booked{background:var(--sold)}
    /* LEFT: booking card (now on left) */
    .booking-card{background:linear-gradient(180deg,#121214,#0b0b0d);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);height:fit-content}
    .booking-card h2{margin:0 0 10px 0}
    .info-row{display:flex;justify-content:space-between;gap:8px;margin-bottom:12px}
    .pill{background:#0f1012;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:14px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0c0c0d;color:#fff}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--yellow);color:#111}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .seat-list{font-weight:700;color:#fff}
    .qr{margin-top:12px;border-radius:8px;overflow:hidden;background:#0b0b0d;border:1px solid rgba(255,255,255,0.02);padding:8px}
    .qr canvas{width:100%;height:auto;display:block}
    .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Right: seat map (now on right) */
    .seat-panel{background:linear-gradient(180deg,#0e0e10,#0b0b0d);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .screen-label{background:#232427;color:#ddd;padding:10px 16px;border-radius:10px;margin:0 auto 14px;width:60%;text-align:center}
    .seat-grid{display:grid;gap:10px;align-items:start}
    .row{display:grid;grid-template-columns:1fr 24px 1fr;gap:12px;align-items:center}
    .side{display:grid;grid-auto-flow:column;gap:10px;justify-content:center}
    .seat{
      width:var(--seat-w);height:var(--seat-h);border-radius:10px;border:2px solid rgba(255,255,255,0.04);
      background:#0f1113;color:#cfd3d6;display:grid;place-items:center;font-weight:700;cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.6), inset 0 -2px 0 rgba(255,255,255,0.02);
    }
    .seat.small{width:44px;height:36px;font-size:12px}
    .seat.empty{background:transparent;border:none;cursor:default;width:12px;height:12px}
    .seat.free{border:2px solid rgba(46,213,115,0.8);color:var(--green);background:transparent}
    .seat.selected{border:2px solid var(--yellow);background:linear-gradient(180deg,#3b2b10,#2f250b);color:#111}
    .seat.sold{background:var(--sold);color:#777;cursor:not-allowed}

    /* responsive */
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr; padding:12px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Sơ đồ chỗ ngồi - Sự kiện TWILIGHT CONCERT</h1>
        <div style="color:var(--muted);font-size:13px">Cột bên trái là khung đặt chỗ, cột bên phải là sơ đồ ghế (tất cả ghế trống).</div>
      </div>
      <div class="legend" role="list" aria-label="Chú thích">
        <div class="item"><span class="sw empty" aria-hidden="true"></span> <span style="color:var(--muted)">Trống</span></div>
        <div class="item"><span class="sw sel" aria-hidden="true"></span> <span style="color:var(--muted)">Đang đặt</span></div>
        <div class="item"><span class="sw booked" aria-hidden="true"></span> <span style="color:var(--muted)">Đã đặt</span></div>
      </div>
    </header>

    <!-- LEFT: booking card (moved to left) -->
    <aside class="booking-card" id="booking">
      <h2>Đặt chỗ</h2>

      <div class="info-row">
        <div class="pill">Vị trí: <span id="selected-places" class="seat-list">—</span></div>
        <div class="pill" id="timer">30:00</div>
      </div>

      <form id="book-form" onsubmit="return false" aria-label="Form đặt chỗ">
        <label for="name">Họ và tên</label>
        <input id="name" name="name" type="text" placeholder="Nguyễn Văn A" required />

        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="user@example.com" />

        <label for="phone">Số điện thoại</label>
        <input id="phone" name="phone" type="tel" placeholder="0123456789" required />

        <div style="margin-top:14px;font-weight:700">Hướng dẫn thanh toán</div>
        <div class="qr" aria-hidden="false">
          <canvas id="qr-canvas" width="420" height="240" style="display:block;border-radius:6px;background:#fff"></canvas>
          <div style="color:var(--muted);font-size:13px;margin-top:8px">Chuyển khoản tới: <strong>TRAN PHUONG ANH</strong> — 0126163397102</div>
        </div>

        <div class="footer-actions">
          <button class="btn ghost" id="clear-all">Hủy</button>
          <button class="btn primary" id="confirm">Xác nhận &amp; Thanh toán</button>
        </div>
      </form>
    </aside>

    <!-- RIGHT: seat map (moved to right) -->
    <section class="seat-panel" id="seat-panel" aria-label="Sơ đồ ghế">
      <div class="screen-label" role="img" aria-label="Màn hình">Cụm rạp màn hình</div>

      <div class="seat-grid" id="seat-grid" aria-live="polite"></div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:14px;justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="pill">Chọn: <strong id="count">0</strong></div>
          <div class="pill">Ghế: <span id="list">—</span></div>
        </div>
        <div>
          <button class="btn ghost" id="reset">Xóa chọn</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Layout: rows A..O, 7 ghế mỗi bên (bên trái đánh số lớn 14..8, bên phải 1..7)
    const ROWS = "ABCDEFGHIJKLMNO".split('');
    const PER_SIDE = 7;
    const seatGrid = document.getElementById('seat-grid');
    const countEl = document.getElementById('count');
    const listEl = document.getElementById('list');
    const selectedPlacesEl = document.getElementById('selected-places');
    const resetBtn = document.getElementById('reset');
    const clearAllBtn = document.getElementById('clear-all');
    const confirmBtn = document.getElementById('confirm');
    const timerEl = document.getElementById('timer');

    // All seats empty: no sold seats
    const sold = new Set([]); // <-- empty set: tất cả ghế trống

    let selected = new Set();

    function makeSeatButton(id, state){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'seat';
      btn.textContent = id;
      btn.dataset.seat = id;
      if(state === 'sold'){
        btn.classList.add('sold');
        btn.disabled = true;
        btn.setAttribute('aria-label', id + ' đã đặt');
      } else {
        // mark as free (trống)
        btn.classList.add('free');
        btn.setAttribute('aria-label', id + ' trống');
        btn.addEventListener('click', onSeatClick);
      }
      return btn;
    }

    function render(){
      seatGrid.innerHTML = '';
      ROWS.forEach(row => {
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        // left side: numbers 14..8 (descending)
        const left = document.createElement('div'); left.className = 'side';
        for(let p=PER_SIDE; p>=1; p--){
          const num = PER_SIDE*2 - p + 1; // 14..8
          const id = row + String(num);
          left.appendChild(makeSeatButton(id, sold.has(id) ? 'sold' : 'free'));
        }
        // aisle marker
        const aisle = document.createElement('div');
        aisle.style.width = '100%';
        // right side: numbers 1..7
        const right = document.createElement('div'); right.className = 'side';
        for(let p=1; p<=PER_SIDE; p++){
          const id = row + String(p);
          right.appendChild(makeSeatButton(id, sold.has(id) ? 'sold' : 'free'));
        }
        rowEl.appendChild(left);
        rowEl.appendChild(aisle);
        rowEl.appendChild(right);
        seatGrid.appendChild(rowEl);
      });
      refreshSelectionUI();
    }

    function onSeatClick(e){
      const id = e.currentTarget.dataset.seat;
      if(selected.has(id)){
        selected.delete(id);
        e.currentTarget.classList.remove('selected');
      } else {
        selected.add(id);
        e.currentTarget.classList.add('selected');
      }
      refreshSelectionUI();
    }

    function refreshSelectionUI(){
      const arr = Array.from(selected).sort();
      countEl.textContent = arr.length;
      listEl.textContent = arr.length ? arr.join(', ') : '—';
      selectedPlacesEl.textContent = arr.length ? arr.join(', ') : '—';
    }

    resetBtn.addEventListener('click', ()=>{
      selected.clear();
      document.querySelectorAll('.seat.selected').forEach(b=>b.classList.remove('selected'));
      refreshSelectionUI();
    });

    clearAllBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      // clear form & selection
      document.getElementById('book-form').reset();
      selected.clear();
      document.querySelectorAll('.seat.selected').forEach(b=>b.classList.remove('selected'));
      refreshSelectionUI();
    });

    // Booking behaviour: try POST /api/bookings, fallback to localStorage
    confirmBtn.addEventListener('click', async ()=>{
      if(selected.size === 0){
        alert('Vui lòng chọn ít nhất 1 ghế.');
        return;
      }
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if(!name || !phone){
        alert('Vui lòng điền họ tên và số điện thoại.');
        return;
      }
      const payload = {
        name,
        email: document.getElementById('email').value.trim(),
        phone,
        seats: Array.from(selected),
        created_at: new Date().toISOString()
      };
      // optimistic: mark seats as sold in UI immediately to avoid reselect
      Array.from(selected).forEach(s=>{
        const b = document.querySelector(`.seat[data-seat="${s}"]`);
        if(b){ b.classList.remove('selected'); b.classList.remove('free'); b.classList.add('sold'); b.disabled = true; b.removeEventListener('click', onSeatClick); }
        sold.add(s);
      });
      try {
        const res = await fetch('/api/bookings', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('server error');
        const data = await res.json();
        // determine booking id from server response
        const bookingId = (data && data.booking && data.booking.id) ? data.booking.id : (data && data.id) ? data.id : ('local_' + Date.now());
        // redirect to payment page with booking id
        location.href = '/payment.html?id=' + encodeURIComponent(bookingId);
      } catch(err){
        // fallback: save to localStorage and redirect to payment page
        const key = 'demo_bookings';
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        const localId = 'local_' + Date.now();
        payload.id = localId;
        existing.push(payload);
        localStorage.setItem(key, JSON.stringify(existing));
        // redirect to payment page with local id
        location.href = '/payment.html?id=' + encodeURIComponent(localId);
      }
      // clear selection after booking (UI already marked seats sold)
      selected.clear();
      refreshSelectionUI();
    });

    // small decorative QR (canvas)
    (function drawQR(){
      const canvas = document.getElementById('qr-canvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#111';
      for(let x=0;x<28;x++){
        for(let y=0;y<16;y++){
          if(Math.random() > 0.7) ctx.fillRect(x*14 + (x%2?2:0), y*14 + (y%2?2:0), 10, 10);
        }
      }
      ctx.fillStyle = '#f7f7f8';
      ctx.fillRect(8,8,220,36);
      ctx.fillStyle = '#111';
      ctx.font = '16px sans-serif';
      ctx.fillText('TRAN PHUONG ANH', 14, 34);
    })();

    // timer demo (30:00 countdown)
    (function startTimer(){
      let remaining = 30*60;
      function tick(){
        const mm = String(Math.floor(remaining/60)).padStart(2,'0');
        const ss = String(remaining%60).padStart(2,'0');
        timerEl.textContent = `${mm}:${ss}`;
        remaining--;
        if(remaining < 0) remaining = 30*60;
      }
      tick(); setInterval(tick,1000);
    })();

    // init render
    render();
  </script>
</body>
</html>
