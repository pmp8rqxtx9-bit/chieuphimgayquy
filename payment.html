<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh toán - Xác nhận đặt chỗ</title>
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b0b0d;color:#fff;padding:28px}
    .card{max-width:820px;margin:0 auto;background:#0f1012;padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 12px}
    .row{display:flex;gap:12px;align-items:flex-start}
    .col{flex:1}
    .qr{width:320px;height:320px;background:#fff;border-radius:8px;display:block}
    .meta{background:#0b0b0d;padding:12px;border-radius:8px;margin-bottom:12px}
    .muted{color:#9aa0a6}
    button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .primary{background:#2ed573;color:#07110a}
    .danger{background:#ff6b6b;color:#111}
  </style>
</head>
<body>
  <div class="card">
    <h1>Xác nhận & Thanh toán</h1>
    <div id="info">Đang tải thông tin đặt chỗ…</div>

    <div style="margin-top:12px;display:flex;gap:12px;align-items:center;justify-content:flex-end">
      <button id="paid" class="primary">Đã thanh toán (test)</button>
      <button id="back" class="danger">Quay lại</button>
    </div>
  </div>

  <script>
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    const id = qs('id');
    const infoEl = document.getElementById('info');
    const backBtn = document.getElementById('back');
    const paidBtn = document.getElementById('paid');

    async function loadBooking(){
      if(!id){ infoEl.innerHTML = '<div class="muted">Không có booking id</div>'; return; }
      // thử lấy từ server
      try{
        const res = await fetch('/api/bookings');
        if(res.ok){
          const list = await res.json();
          const b = list.find(x => x.id === id);
          if(b){ renderBooking(b); return; }
        }
      }catch(e){
        // fallthrough -> try local
      }
      // fallback localStorage
      const existing = JSON.parse(localStorage.getItem('demo_bookings') || '[]');
      const bLocal = existing.find(x => x.id === id);
      if(bLocal) { renderBooking(bLocal); return; }
      // nếu không tìm thấy, hiển thị minimal info từ query (nếu có)
      infoEl.innerHTML = '<div class="muted">Không tìm thấy chi tiết booking. ID: ' + id + '</div>';
    }

    function renderBooking(b){
      const seats = (b.seats||[]).join(', ');
      infoEl.innerHTML = `
        <div style="display:flex;gap:18px;align-items:flex-start">
          <div class="col meta">
            <div><strong>Họ tên:</strong> ${escapeHtml(b.name||'—')}</div>
            <div class="muted">Email: ${escapeHtml(b.email||'—')}</div>
            <div class="muted">Phone: ${escapeHtml(b.phone||'—')}</div>
            <div style="margin-top:8px"><strong>Ghế:</strong> ${escapeHtml(seats||'—')}</div>
            <div class="muted" style="margin-top:8px">Mã booking: <code>${escapeHtml(b.id||'—')}</code></div>
            <div class="muted" style="margin-top:8px">Thời gian: ${new Date(b.created_at||Date.now()).toLocaleString()}</div>
          </div>
          <div style="width:340px">
            <canvas id="qr" width="320" height="320" class="qr"></canvas>
            <div style="color:#9aa0a6;margin-top:8px;font-size:13px">Quét QR để chuyển khoản tới: <strong>TRAN PHUONG ANH</strong> — 0126163397102</div>
          </div>
        </div>
      `;
      drawQRCanvas();
    }

    function drawQRCanvas(){
      const canvas = document.getElementById('qr');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#111';
      for(let x=0;x<26;x++){
        for(let y=0;y<26;y++){
          if(Math.random() > 0.72) ctx.fillRect(x*12 + ((x+y)%2?2:0), y*12 + ((x+y)%2?2:0), 8, 8);
        }
      }
    }

    function escapeHtml(s){ return (s||'').toString().replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    backBtn.addEventListener('click', ()=> history.back());
    paidBtn.addEventListener('click', async ()=>{
      alert('Bạn đã click "Đã thanh toán" (demo). Ở production, kiểm tra giao dịch tại server/payment gateway.');
      location.href = '/';
    });

    loadBooking();
  </script>
</body>
</html>
