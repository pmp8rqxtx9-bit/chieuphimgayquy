<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đặt chỗ rạp phim</title>
  <style>
    :root{
      --accent:#0b76ef;
      --seat-size:36px;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:16px;
      color:#222;
      background: #f7f9fc;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .group{
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 1px 3px rgba(16,24,40,0.06);
      display:flex;
      gap:8px;
      align-items:center;
    }
    label{ font-size:14px; color:#333; min-width:70px; }
    select, button, input[type="text"]{
      padding:8px 10px;
      border:1px solid #d1d9e6;
      border-radius:6px;
      font-size:14px;
      background:white;
    }
    .seat-map{
      margin-top:12px;
      background:#fff;
      padding:18px;
      border-radius:10px;
      box-shadow:0 1px 6px rgba(16,24,40,0.06);
    }
    .screen{
      text-align:center;
      padding:8px 12px;
      background:linear-gradient(90deg,#e6f0ff,#f7fbff);
      border-radius:8px;
      color:#064a9c;
      font-weight:600;
      margin-bottom:12px;
    }
    .seats{
      display:grid;
      grid-template-columns: repeat(12, var(--seat-size));
      gap:8px;
      justify-content:center;
      align-items:center;
    }
    .seat{
      width:var(--seat-size);
      height:var(--seat-size);
      border-radius:6px;
      display:inline-grid;
      place-items:center;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      border:1px solid #cbd6e9;
      background:linear-gradient(#fff,#f2f6ff);
    }
    .seat.available:hover{ transform:translateY(-2px); box-shadow:0 6px 12px rgba(11,118,239,0.12)}
    .seat.selected{ background:linear-gradient(#0b76ef,#085fbf); color:#fff; border-color:transparent; }
    .seat.sold{ background:#e6eaf2; color:#8a95a8; cursor:not-allowed; border-color:#d6dbe8; }
    .seat.empty{ background:transparent; border:none; cursor:default; }
    .legend{ display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap }
    .legend .item{ display:flex; gap:6px; align-items:center; font-size:13px; color:#333 }
    .legend .swatch{ width:18px; height:18px; border-radius:4px; border:1px solid #cbd6e9 }
    .summary{
      margin-top:14px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .summary .pill{
      background:#fff;
      border-radius:8px;
      padding:10px 12px;
      box-shadow:0 1px 3px rgba(16,24,40,0.04);
    }
    .actions{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    button.primary{
      background:var(--accent);
      color:white;
      border:none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
    }
    button.secondary{ background:#fff; border:1px solid #d1d9e6; }
    @media (max-width:640px){
      .seats{ grid-template-columns: repeat(8, var(--seat-size)); }
      header{ gap:8px; }
      label{ min-width:54px; }
    }
  </style>
</head>
<body>
  <h1>Đặt chỗ rạp phim</h1>

  <header>
    <div class="group" id="top-selection">
      <label for="cumrap">Cụm rạp</label>
      <select id="cumrap" aria-label="Chọn cụm rạp"></select>

      <label for="manhinh">Màn hình</label>
      <select id="manhinh" aria-label="Chọn màn hình"></select>

      <label for="phim">Phim</label>
      <select id="phim" aria-label="Chọn phim"></select>

      <label for="suat">Suất</label>
      <select id="suat" aria-label="Chọn suất chiếu"></select>
    </div>
  </header>

  <section class="seat-map" aria-labelledby="seatmap-title">
    <div class="screen" id="screen-label">--- MÀN HÌNH ---</div>

    <div class="seats" id="seats" role="grid" aria-label="Sơ đồ ghế"></div>

    <div class="legend">
      <div class="item"><span class="swatch" style="background:#fff;border:1px solid #cbd6e9"></span> Ghế trống</div>
      <div class="item"><span class="swatch" style="background:#0b76ef"></span> Đang chọn</div>
      <div class="item"><span class="swatch" style="background:#e6eaf2"></span> Đã bán</div>
    </div>

    <div class="summary" aria-live="polite">
      <div class="pill">Chọn: <strong id="chosen-count">0</strong> ghế</div>
      <div class="pill">Ghế: <span id="chosen-list">—</span></div>

      <div class="actions">
        <button class="secondary" id="reset">Xóa chọn</button>
        <button class="primary" id="book">Đặt chỗ</button>
      </div>
    </div>
  </section>

  <script>
    // Dữ liệu mẫu: cụm rạp -> màn hình -> (danh sách ghế sẵn bán)
    const data = {
      "CineStar Vincom": {
        "IMAX": { sold: ["A1","A2","B3","C4"] },
        "Standard": { sold: ["D5","E6","B2"] }
      },
      "Galaxy Nguyễn Du": {
        "Galaxy Screen 1": { sold: ["A1","A3","F10"] },
        "Galaxy Screen 2": { sold: ["C1","C2","C3","C4"] }
      },
      "Lotte Cinema": {
        "Lotte Premium": { sold: [] },
        "Lotte Screen 2": { sold: ["B1","B2","B3","B4","B5"] }
      }
    };

    const movies = ["Chuyến tàu sinh tử", "Người hùng cuối cùng", "Giấc mơ không ngủ"];
    const suats = ["10:00", "13:30", "16:45", "19:30", "21:45"];

    const cumrapEl = document.getElementById('cumrap');
    const manhinhEl = document.getElementById('manhinh');
    const phimEl = document.getElementById('phim');
    const suatEl = document.getElementById('suat');
    const seatsEl = document.getElementById('seats');
    const screenLabelEl = document.getElementById('screen-label');
    const chosenCountEl = document.getElementById('chosen-count');
    const chosenListEl = document.getElementById('chosen-list');
    const resetBtn = document.getElementById('reset');
    const bookBtn = document.getElementById('book');

    // Tạo danh sách cụm rạp
    function populateCine(){
      cumrapEl.innerHTML = '';
      Object.keys(data).forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        cumrapEl.appendChild(opt);
      });
    }
    // Tạo màn hình theo cụm rạp
    function populateScreens(cineName){
      manhinhEl.innerHTML = '';
      const screens = Object.keys(data[cineName] || {});
      screens.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        manhinhEl.appendChild(opt);
      });
    }
    function populateMovies(){ movies.forEach(m=> { const o=document.createElement('option'); o.value=m; o.textContent=m; phimEl.appendChild(o); }) }
    function populateSuats(){ suats.forEach(s=> { const o=document.createElement('option'); o.value=s; o.textContent=s; suatEl.appendChild(o); }) }

    // Tạo sơ đồ ghế (rows A-F, cols 1-10). Một vài ô là khoảng trống để căn chỉnh.
    const ROWS = ['A','B','C','D','E','F'];
    const COLS = 10;

    function renderSeatMap(soldList=[]){
      seatsEl.innerHTML = '';
      screenLabelEl.textContent = manhinhEl.value ? `${manhinhEl.value}` : '--- MÀN HÌNH ---';
      const soldSet = new Set(soldList);
      // pad left empty col for aisle visual: we'll produce 12 columns but only fill seats for cols 1-10 and two empties
      for(let r of ROWS){
        for(let c=0;c<12;c++){
          const wrapper = document.createElement('div');
          if(c===0 || c===11){
            wrapper.className = 'seat empty';
            wrapper.setAttribute('aria-hidden','true');
            wrapper.textContent = '';
            seatsEl.appendChild(wrapper);
            continue;
          }
          const col = c; // 1..10
          const seatId = r + col;
          const btn = document.createElement('button');
          btn.className = 'seat available';
          btn.type = 'button';
          btn.textContent = seatId;
          btn.dataset.seat = seatId;
          btn.setAttribute('aria-pressed','false');
          if(soldSet.has(seatId)){
            btn.className = 'seat sold';
            btn.disabled = true;
            btn.setAttribute('aria-label', seatId + ': đã bán');
          } else {
            btn.addEventListener('click', toggleSeat);
            btn.setAttribute('aria-label', seatId + ': ghế trống');
          }
          seatsEl.appendChild(btn);
        }
      }
      updateSummary();
    }

    // Quản lý chọn ghế
    function toggleSeat(e){
      const el = e.currentTarget;
      if(el.classList.contains('selected')){
        el.classList.remove('selected');
        el.setAttribute('aria-pressed','false');
      } else {
        el.classList.add('selected');
        el.setAttribute('aria-pressed','true');
      }
      updateSummary();
    }

    function getSelectedSeats(){
      return Array.from(seatsEl.querySelectorAll('.seat.selected')).map(b=>b.dataset.seat);
    }

    function updateSummary(){
      const chosen = getSelectedSeats();
      chosenCountEl.textContent = chosen.length;
      chosenListEl.textContent = chosen.length ? chosen.join(', ') : '—';
    }

    resetBtn.addEventListener('click', ()=>{
      seatsEl.querySelectorAll('.seat.selected').forEach(s=>{ s.classList.remove('selected'); s.setAttribute('aria-pressed','false'); });
      updateSummary();
    });

    // Khi đổi cụm rạp -> cập nhật màn hình -> render seat map
    cumrapEl.addEventListener('change', ()=>{
      const cine = cumrapEl.value;
      populateScreens(cine);
      manhinhEl.dispatchEvent(new Event('change'));
      saveToUrl();
    });

    // Khi đổi màn hình -> render seat map theo danh sách sold
    manhinhEl.addEventListener('change', ()=>{
      const cine = cumrapEl.value, screen = manhinhEl.value;
      const sold = (data[cine] && data[cine][screen] && data[cine][screen].sold) ? data[cine][screen].sold : [];
      renderSeatMap(sold);
      saveToUrl();
    });

    // Khi đổi phim/suất -> lưu vào URL
    phimEl.addEventListener('change', saveToUrl);
    suatEl.addEventListener('change', saveToUrl);

    // Đặt chỗ: simple demo -> sẽ chuyển đến URL với query params phim, suat, ghe, cumrap, manhinh
    bookBtn.addEventListener('click', ()=>{
      const chosen = getSelectedSeats();
      if(chosen.length === 0){
        alert('Vui lòng chọn ít nhất 1 ghế trước khi đặt.');
        return;
      }
      const params = new URLSearchParams(window.location.search);
      params.set('cumrap', cumrapEl.value);
      params.set('manhinh', manhinhEl.value);
      params.set('phim', phimEl.value);
      params.set('suat', suatEl.value);
      params.set('ghe', chosen.join(','));
      // Thay vì gửi server, ví dụ redirect tới trang xác nhận cùng query params
      const url = `${location.pathname}?${params.toString()}`;
      // dùng replace để không làm dầy lịch sử, trong thực tế có thể gửi lên server
      location.href = url;
    });

    // Lưu trạng thái hiện tại vào URL (không reload)
    function saveToUrl(){
      const params = new URLSearchParams(window.location.search);
      params.set('cumrap', cumrapEl.value);
      params.set('manhinh', manhinhEl.value);
      params.set('phim', phimEl.value);
      params.set('suat', suatEl.value);
      const newUrl = `${location.pathname}?${params.toString()}`;
      history.replaceState(null, '', newUrl);
    }

    // Load từ URL (nếu có), khởi tạo UI
    function loadFromUrl(){
      populateCine();
      populateMovies();
      populateSuats();

      const url = new URL(location.href);
      const qCumrap = url.searchParams.get('cumrap');
      const qManhinh = url.searchParams.get('manhinh');
      const qPhim = url.searchParams.get('phim');
      const qSuat = url.searchParams.get('suat');
      const qGhe = url.searchParams.get('ghe'); // danh sách ghế

      // chọn cụm rạp nếu có, nếu không chọn mặc định đầu tiên
      if(qCumrap && data[qCumrap]) cumrapEl.value = qCumrap;
      else cumrapEl.selectedIndex = 0;

      populateScreens(cumrapEl.value);

      if(qManhinh && data[cumrapEl.value] && data[cumrapEl.value][qManhinh]) manhinhEl.value = qManhinh;
      else manhinhEl.selectedIndex = 0;

      if(qPhim && movies.includes(qPhim)) phimEl.value = qPhim;
      else phimEl.selectedIndex = 0;

      if(qSuat && suats.includes(qSuat)) suatEl.value = qSuat;
      else suatEl.selectedIndex = 0;

      // Render seats, then pre-select from qGhe if possible (ignoring sold)
      const sold = (data[cumrapEl.value] && data[cumrapEl.value][manhinhEl.value] && data[cumrapEl.value][manhinhEl.value].sold) ? data[cumrapEl.value][manhinhEl.value].sold : [];
      renderSeatMap(sold);

      if(qGhe){
        const list = qGhe.split(',').map(s=>s.trim()).filter(Boolean);
        list.forEach(id=>{
          const btn = seatsEl.querySelector(`.seat[data-seat="${id}"]`);
          if(btn && !btn.classList.contains('sold')){
            btn.classList.add('selected');
            btn.setAttribute('aria-pressed','true');
          }
        });
        updateSummary();
      }
    }

    // Khởi tạo
    loadFromUrl();

    // Nếu muốn thêm behaviour khác (ví dụ gởi server, thanh toán), có thể mở rộng ở đây.
  </script>
</body>
</html>
